// Prisma Schema for Handled Platform
// Uses PostgreSQL multi-schema support

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["config", "company", "customer", "workspace", "reference"]
}

// ============================================
// CONFIG SCHEMA - Auth and runtime state
// ============================================

model Role {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
  @@schema("config")
}

model Permission {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  category    String
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]

  @@map("permissions")
  @@schema("config")
}

model RolePermission {
  roleId       Int      @map("role_id")
  permissionId Int      @map("permission_id")
  granted      Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
  @@schema("config")
}

model User {
  id             String    @id
  email          String    @unique
  hashedPassword String    @map("hashed_password")
  name           String
  role           String    @default("admin") // Deprecated - kept for migration compatibility
  roleId         Int       @map("role_id")
  disabled       Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  userRole               Role               @relation(fields: [roleId], references: [id], onDelete: Restrict)
  sessions               Session[]
  integrationRuns        IntegrationRun[]
  warehouses             Warehouse[]
  // Billing relations
  createdRateCards       RateCard[]
  linkedRateCardContracts RateCardContract[]
  importedBillingActivities BillingActivity[]
  createdInvoices        Invoice[]
  recordedPayments       Payment[]

  @@map("users")
  @@schema("config")
}

model Session {
  id        String   @id
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@schema("config")
}

model IntegrationRun {
  id               Int       @id @default(autoincrement())
  integrationId    String    @map("integration_id")
  filename         String?
  status           String    @default("pending")
  recordsProcessed Int       @default(0) @map("records_processed")
  recordsFailed    Int       @default(0) @map("records_failed")
  errors           Json?
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  runBy            String?   @map("run_by")
  createdAt        DateTime  @default(now()) @map("created_at")

  user User? @relation(fields: [runBy], references: [id])

  @@map("integration_runs")
  @@schema("config")
}

// ============================================
// COMPANY SCHEMA - Your warehouses and assets
// ============================================

model Warehouse {
  id             String   @id @default(dbgenerated("'wh_'::text || gen_random_uuid()"))
  code           String   @unique
  name           String
  type           String
  status         String   @default("active")
  address        Json
  timezone       String   @default("America/Chicago")
  capacity       Json     @default("{}")
  operatingHours Json?    @map("operating_hours")
  capabilities   String[]
  managerId      String?  @map("manager_id")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  manager              User?                 @relation(fields: [managerId], references: [id])
  zones                WarehouseZone[]
  warehouseAllocations WarehouseAllocation[]

  @@map("warehouses")
  @@schema("company")
}

model WarehouseZone {
  id              String   @id @default(dbgenerated("'zone_'::text || gen_random_uuid()"))
  warehouseId     String   @map("warehouse_id")
  zoneCode        String   @map("zone_code")
  zoneType        String?  @map("zone_type")
  capacityPallets Int?     @map("capacity_pallets")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, zoneCode])
  @@map("warehouse_zones")
  @@schema("company")
}

// ============================================
// CUSTOMER SCHEMA - Client organizations and facilities
// ============================================

model Customer {
  id             String   @id @default(dbgenerated("'cust_'::text || gen_random_uuid()"))
  name           String
  slug           String   @unique
  status         String   @default("prospect")
  setupProgress  Json?    @map("setup_progress") @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  warehouseAllocations WarehouseAllocation[]
  facilities           CustomerFacility[]
  contacts             Contact[]
  contracts            Contract[]
  settings             CustomerSettings?
  // Billing relations
  rateCards            RateCard[]
  billingActivities    BillingActivity[]
  invoices             Invoice[]

  @@map("customers")
  @@schema("customer")
  @@index([status])
}

model WarehouseAllocation {
  id                  String   @id @default(dbgenerated("'alloc_'::text || gen_random_uuid()"))
  customerId          String   @map("customer_id")
  companyWarehouseId  String   @map("company_warehouse_id")
  isPrimary           Boolean? @default(false) @map("is_primary")
  spaceAllocated      Json?    @map("space_allocated")
  zoneAssignment      String?  @map("zone_assignment")
  status              String   @default("active")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")

  customer  Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [companyWarehouseId], references: [id], onDelete: Restrict)

  @@unique([customerId, companyWarehouseId])
  @@map("warehouse_allocations")
  @@schema("customer")
  @@index([customerId])
  @@index([companyWarehouseId])
  @@index([status])
}

model CustomerFacility {
  id             String   @id @default(dbgenerated("'fac_'::text || gen_random_uuid()"))
  customerId     String   @map("customer_id")
  name           String
  facilityType   String?  @map("facility_type")
  address        Json
  isSource       Boolean? @default(false) @map("is_source")
  isDestination  Boolean? @default(false) @map("is_destination")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("facilities")
  @@schema("customer")
  @@index([customerId])
  @@index([isSource])
  @@index([isDestination])
}

model Contact {
  id             String   @id @default(dbgenerated("'contact_'::text || gen_random_uuid()"))
  customerId     String   @map("customer_id")
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  title          String?
  email          String?
  phone          String?
  role           String?
  isPrimary      Boolean? @default(false) @map("is_primary")
  active         Boolean? @default(true)
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("contacts")
  @@schema("customer")
  @@index([customerId])
  @@index([isPrimary])
  @@index([active])
}

model Contract {
  id                      String    @id @default(dbgenerated("'contract_'::text || gen_random_uuid()"))
  customerId              String    @map("customer_id")
  contractNumber          String?   @unique @map("contract_number")
  name                    String
  startDate               DateTime  @map("start_date") @db.Date
  endDate                 DateTime? @map("end_date") @db.Date
  autoRenew               Boolean?  @default(false) @map("auto_renew")
  status                  String    @default("draft")
  billingCycle            String?   @map("billing_cycle")
  paymentTerms            String?   @map("payment_terms")
  notes                   String?
  // Billing system enhancements
  contractType            String?   @map("contract_type")
  parentContractId        String?   @map("parent_contract_id")
  supersededByContractId  String?   @map("superseded_by_contract_id")
  executionDate           DateTime? @map("execution_date") @db.Date
  amendmentNumber         Int?      @map("amendment_number")
  documentUrl             String?   @map("document_url")
  terms                   Json?
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @default(now()) @updatedAt @map("updated_at")

  customer              Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  rateCards             RateCard[]
  rateCardLinks         RateCardContract[]
  // Self-referential relations for amendments
  parentContract        Contract?          @relation("ContractAmendments", fields: [parentContractId], references: [id])
  childContracts        Contract[]         @relation("ContractAmendments")
  supersededBy          Contract?          @relation("ContractSupersession", fields: [supersededByContractId], references: [id])
  supersedes            Contract[]         @relation("ContractSupersession")

  @@map("contracts")
  @@schema("customer")
  @@index([customerId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([contractType])
  @@index([parentContractId])
}

model RateCard {
  id                   String    @id @default(dbgenerated("'rate_'::text || gen_random_uuid()"))
  customerId           String?   @map("customer_id")
  name                 String
  effectiveDate        DateTime  @map("effective_date")
  expiresDate          DateTime? @map("expires_date")
  version              Int?      @default(1)
  supersedesId         String?   @map("supersedes_id")
  rates                Json      @default("{}")
  isActive             Boolean?  @default(true) @map("is_active")
  notes                String?
  // Billing system enhancements
  billingCycles        Json      @default("{}") @map("billing_cycles")
  minimumMonthlyCharge Decimal?  @map("minimum_monthly_charge") @db.Decimal(10, 2)
  basedOnTemplate      String?   @map("based_on_template")
  // Adjustment support
  rateCardType         String?   @default("standard") @map("rate_card_type")
  parentRateCardId     String?   @map("parent_rate_card_id")
  createdBy            String?   @map("created_by")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at")

  customer         Customer?          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdByUser    User?              @relation(fields: [createdBy], references: [id])
  supersedes       RateCard?          @relation("RateCardSupersedes", fields: [supersedesId], references: [id])
  superseded       RateCard[]         @relation("RateCardSupersedes")
  parent           RateCard?          @relation("RateCardAdjustments", fields: [parentRateCardId], references: [id])
  adjustments      RateCard[]         @relation("RateCardAdjustments")
  contractLinks    RateCardContract[]
  billingActivities BillingActivity[]

  @@map("rate_cards")
  @@schema("customer")
  @@index([customerId])
  @@index([effectiveDate])
  @@index([expiresDate])
  @@index([customerId, isActive])
  @@index([rateCardType])
  @@index([parentRateCardId])
}

model CustomerSettings {
  customerId              String   @id @map("customer_id")
  portalEnabled           Boolean? @default(false) @map("portal_enabled")
  portalSubdomain         String?  @unique @map("portal_subdomain")
  notificationEmail       String?  @map("notification_email")
  notificationPreferences Json?    @default("{}") @map("notification_preferences")
  timezone                String?  @default("America/Chicago")
  settings                Json?    @default("{}")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @default(now()) @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("settings")
  @@schema("customer")
  @@index([portalEnabled])
}

// ============================================
// BILLING MODELS
// ============================================

model RateCardContract {
  rateCardId String   @map("rate_card_id")
  contractId String   @map("contract_id")
  linkType   String?  @map("link_type")
  linkedAt   DateTime @default(now()) @map("linked_at")
  linkedBy   String?  @map("linked_by")
  notes      String?

  rateCard     RateCard @relation(fields: [rateCardId], references: [id], onDelete: Cascade)
  contract     Contract @relation(fields: [contractId], references: [id], onDelete: Restrict)
  linkedByUser User?    @relation(fields: [linkedBy], references: [id])

  @@id([rateCardId, contractId])
  @@map("rate_card_contracts")
  @@schema("customer")
  @@index([rateCardId])
  @@index([contractId])
}

model BillingActivity {
  id                 String    @id @default(dbgenerated("'act_'::text || gen_random_uuid()"))
  customerId         String    @map("customer_id")
  activityDate       DateTime  @map("activity_date")
  type               String
  quantity           Decimal   @db.Decimal(10, 3)
  unit               String?
  description        String?
  referenceId        String?   @map("reference_id")
  importBatchId      String?   @map("import_batch_id")
  rateApplied        Decimal?  @map("rate_applied") @db.Decimal(10, 2)
  rateCardId         String?   @map("rate_card_id")
  amount             Decimal?  @db.Decimal(12, 2)
  billingCycle       String    @map("billing_cycle")
  billingPeriodStart DateTime? @map("billing_period_start") @db.Date
  isManualOverride   Boolean?  @default(false) @map("is_manual_override")
  overrideReason     String?   @map("override_reason")
  source             String?
  metadata           Json?
  invoiced           Boolean?  @default(false)
  invoiceId          String?   @map("invoice_id")
  importedAt         DateTime  @default(now()) @map("imported_at")
  importedBy         String?   @map("imported_by")

  customer      Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  rateCard      RateCard?    @relation(fields: [rateCardId], references: [id])
  invoice       Invoice?     @relation(fields: [invoiceId], references: [id])
  importedByUser User?       @relation(fields: [importedBy], references: [id])
  invoiceLines  InvoiceLine[]

  @@unique([customerId, referenceId, activityDate, type])
  @@map("billing_activities")
  @@schema("customer")
  @@index([customerId])
  @@index([activityDate])
  @@index([type])
  @@index([referenceId])
  @@index([customerId, billingCycle, billingPeriodStart])
  @@index([customerId, invoiced])
  @@index([importBatchId])
  @@index([rateCardId])
  @@index([invoiceId])
}

model Invoice {
  id             String    @id @default(dbgenerated("'inv_'::text || gen_random_uuid()"))
  customerId     String    @map("customer_id")
  invoiceNumber  String    @unique @map("invoice_number")
  billingCycle   String    @map("billing_cycle")
  periodStart    DateTime  @map("period_start") @db.Date
  periodEnd      DateTime  @map("period_end") @db.Date
  issuedAt       DateTime? @map("issued_at")
  dueDate        DateTime? @map("due_date")
  status         String    @default("draft")
  subtotal       Decimal   @db.Decimal(12, 2)
  tax            Decimal   @default(0) @db.Decimal(12, 2)
  total          Decimal   @db.Decimal(12, 2)
  balanceDue     Decimal   @map("balance_due") @db.Decimal(12, 2)
  dataSnapshot   Json?     @map("data_snapshot")
  pdfUrl         String?   @map("pdf_url")
  notes          String?
  internalNotes  String?   @map("internal_notes")
  createdAt      DateTime  @default(now()) @map("created_at")
  createdBy      String?   @map("created_by")
  updatedAt      DateTime  @default(now()) @updatedAt @map("updated_at")

  customer        Customer          @relation(fields: [customerId], references: [id], onDelete: Restrict)
  createdByUser   User?             @relation(fields: [createdBy], references: [id])
  lines           InvoiceLine[]
  payments        Payment[]
  billingActivities BillingActivity[]

  @@map("invoices")
  @@schema("customer")
  @@index([customerId])
  @@index([invoiceNumber])
  @@index([customerId, periodStart, periodEnd])
  @@index([status])
  @@index([billingCycle])
  @@index([dueDate, status])
}

model InvoiceLine {
  id          String   @id @default(dbgenerated("'line_'::text || gen_random_uuid()"))
  invoiceId   String   @map("invoice_id")
  activityId  String?  @map("activity_id")
  description String
  category    String?
  quantity    Decimal  @db.Decimal(10, 3)
  unit        String?
  unitRate    Decimal  @map("unit_rate") @db.Decimal(10, 2)
  lineTotal   Decimal  @map("line_total") @db.Decimal(12, 2)
  lineOrder   Int?     @map("line_order")

  invoice  Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  activity BillingActivity? @relation(fields: [activityId], references: [id])

  @@map("invoice_lines")
  @@schema("customer")
  @@index([invoiceId])
  @@index([activityId])
  @@index([category])
}

model Payment {
  id         String   @id @default(dbgenerated("'pay_'::text || gen_random_uuid()"))
  invoiceId  String   @map("invoice_id")
  amount     Decimal  @db.Decimal(12, 2)
  paymentDate DateTime @map("payment_date") @db.Date
  method     String
  reference  String?
  status     String   @default("applied")
  notes      String?
  recordedAt DateTime @default(now()) @map("recorded_at")
  recordedBy String?  @map("recorded_by")

  invoice       Invoice @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  recordedByUser User?  @relation(fields: [recordedBy], references: [id])

  @@map("payments")
  @@schema("customer")
  @@index([invoiceId])
  @@index([paymentDate])
  @@index([status])
  @@index([method])
}

// ============================================
// REFERENCE SCHEMA - Transformed stable data
// ============================================

model Carrier {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  services Service[]

  @@map("carriers")
  @@schema("reference")
}

model Service {
  id        Int      @id @default(autoincrement())
  carrierId Int      @map("carrier_id")
  code      String
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  carrier Carrier @relation(fields: [carrierId], references: [id])

  @@unique([carrierId, code])
  @@map("services")
  @@schema("reference")
}

model Zip3Demographics {
  zip3            String   @id
  totalPopulation Int      @default(0) @map("total_population")
  totalHouseholds Int      @default(0) @map("total_households")
  zipCount        Int      @default(0) @map("zip_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("zip3_demographics")
  @@schema("reference")
}

model Zip3Centroid {
  zip3            String   @id
  latitude        Decimal? @db.Decimal(10, 7)
  longitude       Decimal? @db.Decimal(10, 7)
  primaryCity     String?  @map("primary_city")
  stateId         String?  @map("state_id")
  stateName       String?  @map("state_name")
  statePopulation Int?     @map("state_population")
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("zip3_centroids")
  @@schema("reference")
}

model DeliveryMatrix {
  id          Int      @id @default(autoincrement())
  originZip   String   @map("origin_zip")
  destZip     String   @map("dest_zip")
  carrierCode String   @map("carrier_code")
  serviceCode String   @map("service_code")
  transitDays Int      @map("transit_days")
  zone        String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([originZip, destZip, carrierCode, serviceCode])
  @@map("delivery_matrix")
  @@schema("reference")
}

