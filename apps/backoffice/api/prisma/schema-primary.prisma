// Prisma Schema for PRIMARY Database (DBaaS)
// Contains: config schema (auth, users, roles, permissions, integration_runs)
//           company schema (warehouses, zones)
//           customer schema (organizations, facilities, contacts, contracts)

generator client {
  provider = "prisma-client"
  output   = "../node_modules/@prisma/client-primary"
}

datasource db {
  provider = "postgresql"
  schemas  = ["config", "company", "customer"]
}

// ============================================
// CONFIG SCHEMA - Auth and runtime state
// ============================================

model Role {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  icon        String   @default("shield")
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
  @@schema("config")
}

model Permission {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]

  @@map("permissions")
  @@schema("config")
}

model UserRole {
  userId    String   @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
  @@schema("config")
}

model RolePermission {
  roleId       Int      @map("role_id")
  permissionId Int      @map("permission_id")
  granted      Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
  @@schema("config")
}

model User {
  id             String    @id
  email          String    @unique
  hashedPassword String    @map("hashed_password")
  name           String
  disabled       Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  userRoles          UserRole[]
  sessions           Session[]
  integrationRuns    IntegrationRun[]
  managedWarehouses  Warehouse[]
  contactLogs        ContactLog[]     @relation("LoggedByUser")

  @@map("users")
  @@schema("config")
}

model Session {
  id        String   @id
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@schema("config")
}

model IntegrationRun {
  id               Int       @id @default(autoincrement())
  integrationId    String    @map("integration_id")
  filename         String?
  status           String    @default("pending")
  recordsProcessed Int       @default(0) @map("records_processed")
  recordsFailed    Int       @default(0) @map("records_failed")
  errors           Json?
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  runBy            String?   @map("run_by")
  createdAt        DateTime  @default(now()) @map("created_at")

  user User? @relation(fields: [runBy], references: [id])

  @@map("integration_runs")
  @@schema("config")
}

// ============================================
// COMPANY SCHEMA - YOUR operational assets
// ============================================

model Warehouse {
  id              String    @id @default(dbgenerated("'wh_' || gen_random_uuid()"))
  code            String    @unique
  name            String
  type            String
  status          String    @default("active")
  address         Json
  timezone        String    @default("America/Chicago")
  capacity        Json      @default("{}")
  operatingHours  Json?     @map("operating_hours")
  capabilities    String[]
  managerId       String?   @map("manager_id")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  manager              User?                 @relation(fields: [managerId], references: [id])
  zones                WarehouseZone[]
  warehouseAllocations WarehouseAllocation[]

  @@map("warehouses")
  @@schema("company")
  @@index([code])
  @@index([status])
  @@index([managerId])
}

model WarehouseZone {
  id              String   @id @default(dbgenerated("'zone_' || gen_random_uuid()"))
  warehouseId     String   @map("warehouse_id")
  zoneCode        String   @map("zone_code")
  zoneType        String?  @map("zone_type")
  capacityPallets Int?     @map("capacity_pallets")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, zoneCode])
  @@map("warehouse_zones")
  @@schema("company")
  @@index([warehouseId])
}

// ============================================
// CUSTOMER SCHEMA - THEIR data (multi-tenant)
// ============================================

model Customer {
  id             String   @id @default(dbgenerated("'cust_' || gen_random_uuid()"))
  name           String
  slug           String   @unique
  status         String   @default("prospect")
  setupProgress  Json     @default("{}") @map("setup_progress")
  address        Json?
  internalNotes  String?  @map("internal_notes")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  warehouseAllocations WarehouseAllocation[]
  facilities           CustomerFacility[]
  contacts             Contact[]
  contracts            Contract[]
  settings             CustomerSettings?
  contactLog           ContactLog[]

  @@map("customers")
  @@schema("customer")
  @@index([status])
}

model WarehouseAllocation {
  id                  String   @id @default(dbgenerated("'alloc_' || gen_random_uuid()"))
  customerId          String   @map("customer_id")
  companyWarehouseId  String   @map("company_warehouse_id")
  isPrimary           Boolean  @default(false) @map("is_primary")
  spaceAllocated      Json?    @map("space_allocated")
  zoneAssignment      String?  @map("zone_assignment")
  status              String   @default("active")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  customer  Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [companyWarehouseId], references: [id], onDelete: Restrict)

  @@unique([customerId, companyWarehouseId])
  @@map("warehouse_allocations")
  @@schema("customer")
  @@index([customerId])
  @@index([companyWarehouseId])
  @@index([status])
}

model CustomerFacility {
  id             String   @id @default(dbgenerated("'fac_' || gen_random_uuid()"))
  customerId     String   @map("customer_id")
  name           String
  facilityType   String?  @map("facility_type")
  address        Json
  isSource       Boolean  @default(false) @map("is_source")
  isDestination  Boolean  @default(false) @map("is_destination")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("facilities")
  @@schema("customer")
  @@index([customerId])
  @@index([isSource])
  @@index([isDestination])
}

model Contact {
  id             String   @id @default(dbgenerated("'contact_' || gen_random_uuid()"))
  customerId     String   @map("customer_id")
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  title          String?
  email          String?
  phone          String?
  role           String?
  isPrimary      Boolean  @default(false) @map("is_primary")
  active         Boolean  @default(true)
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  customer   Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contactLog ContactLog[]

  @@map("contacts")
  @@schema("customer")
  @@index([customerId])
  @@index([isPrimary])
  @@index([active])
}

model ContactLog {
  id            String   @id @default(dbgenerated("'log_' || gen_random_uuid()"))
  customerId    String   @map("customer_id")
  contactId     String?  @map("contact_id")
  loggedByUserId String  @map("logged_by_user_id")
  contactType   String   @map("contact_type")
  subject       String?
  notes         String?
  occurredAt    DateTime @map("occurred_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact  Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  user     User     @relation("LoggedByUser", fields: [loggedByUserId], references: [id])

  @@map("contact_log")
  @@schema("customer")
  @@index([customerId])
  @@index([contactId])
  @@index([occurredAt])
  @@index([contactType])
}

model Contract {
  id             String    @id @default(dbgenerated("'contract_' || gen_random_uuid()"))
  customerId     String    @map("customer_id")
  contractNumber String?   @unique @map("contract_number")
  name           String
  startDate      DateTime  @map("start_date") @db.Date
  endDate        DateTime? @map("end_date") @db.Date
  autoRenew      Boolean   @default(false) @map("auto_renew")
  status         String    @default("draft")
  billingCycle   String?   @map("billing_cycle")
  paymentTerms   String?   @map("payment_terms")
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  rateCards RateCard[]

  @@map("contracts")
  @@schema("customer")
  @@index([customerId])
  @@index([status])
  @@index([startDate, endDate])
}

model RateCard {
  id             String    @id @default(dbgenerated("'rate_' || gen_random_uuid()"))
  contractId     String    @map("contract_id")
  name           String
  effectiveDate  DateTime  @map("effective_date") @db.Date
  expirationDate DateTime? @map("expiration_date") @db.Date
  version        Int       @default(1)
  supersedesId   String?   @map("supersedes_id")
  rates          Json      @default("{}")
  isActive       Boolean   @default(true) @map("is_active")
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("rate_cards")
  @@schema("customer")
  @@index([contractId])
  @@index([isActive])
  @@index([effectiveDate])
}

model CustomerSettings {
  customerId              String   @id @map("customer_id")
  portalEnabled           Boolean  @default(false) @map("portal_enabled")
  portalSubdomain         String?  @unique @map("portal_subdomain")
  notificationEmail       String?  @map("notification_email")
  notificationPreferences Json     @default("{}") @map("notification_preferences")
  timezone                String   @default("America/Chicago")
  settings                Json     @default("{}")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("settings")
  @@schema("customer")
  @@index([portalEnabled])
}