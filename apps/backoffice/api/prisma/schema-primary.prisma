// Prisma Schema for PRIMARY Database (DBaaS)
// Contains: config schema (auth, users, roles, permissions, integration_runs)
//           company schema (warehouses, zones)
//           customer schema (organizations, facilities, contacts, contracts)

generator client {
  provider = "prisma-client"
  output   = "../node_modules/@prisma/client-primary"
}

datasource db {
  provider = "postgresql"
  schemas  = ["config", "company", "customer"]
}

// ============================================
// CONFIG SCHEMA - Auth and runtime state
// ============================================

model Role {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  icon        String   @default("shield")
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // Lifecycle management
  retired        Boolean   @default(false)
  retiredAt      DateTime? @map("retired_at")
  retiredBy      String?   @map("retired_by")
  retiredReason  String?   @map("retired_reason")

  userRoles       UserRole[]
  rolePermissions RolePermission[]
  retiredByUser   User?      @relation("RoleRetiredBy", fields: [retiredBy], references: [id])

  @@map("roles")
  @@schema("config")
}

model Permission {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  category    String?
  createdAt   DateTime @default(now()) @map("created_at")

  rolePermissions RolePermission[]

  @@map("permissions")
  @@schema("config")
}

model UserRole {
  userId    String   @map("user_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
  @@schema("config")
}

model RolePermission {
  roleId       Int      @map("role_id")
  permissionId Int      @map("permission_id")
  granted      Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
  @@schema("config")
}

model User {
  id             String    @id
  email          String    @unique
  hashedPassword String    @map("hashed_password")
  name           String
  disabled       Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  
  // Lifecycle management
  deleted        Boolean   @default(false)
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by")
  deletedReason  String?   @map("deleted_reason")

  userRoles            UserRole[]
  sessions             Session[]
  integrationRuns      IntegrationRun[]
  managedWarehouses    Warehouse[]
  contactLogs          ContactLog[]  @relation("LoggedByUser")
  deletedCustomers     Customer[]    @relation("CustomerDeletedBy")
  retiredCustomers     Customer[]    @relation("CustomerRetiredBy")
  deletedWarehouses    Warehouse[]   @relation("WarehouseDeletedBy")
  retiredWarehouses    Warehouse[]   @relation("WarehouseRetiredBy")
  deletedContacts      Contact[]     @relation("ContactDeletedBy")
  archivedContracts    Contract[]    @relation("ContractArchivedBy")
  retiredRoles         Role[]        @relation("RoleRetiredBy")
  // Billing relations
  createdRateCards              RateCard[]           @relation("RateCardCreatedBy")
  archivedRateCards             RateCard[]           @relation("RateCardArchivedBy")
  linkedRateCardContracts       RateCardContract[]   @relation("RateCardContractLinkedBy")
  importedBillingActivities     BillingActivity[]    @relation("BillingActivityImportedBy")
  createdInvoices               Invoice[]            @relation("InvoiceCreatedBy")
  recordedPayments              Payment[]            @relation("PaymentRecordedBy")

  @@map("users")
  @@schema("config")
}

model Session {
  id        String   @id
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
  @@schema("config")
}

model IntegrationRun {
  id               Int       @id @default(autoincrement())
  integrationId    String    @map("integration_id")
  filename         String?
  status           String    @default("pending")
  recordsProcessed Int       @default(0) @map("records_processed")
  recordsFailed    Int       @default(0) @map("records_failed")
  errors           Json?
  startedAt        DateTime? @map("started_at")
  completedAt      DateTime? @map("completed_at")
  runBy            String?   @map("run_by")
  createdAt        DateTime  @default(now()) @map("created_at")

  user User? @relation(fields: [runBy], references: [id])

  @@map("integration_runs")
  @@schema("config")
}

// ============================================
// COMPANY SCHEMA - YOUR operational assets
// ============================================

model Warehouse {
  id              String    @id @default(dbgenerated("'wh_' || gen_random_uuid()"))
  code            String    @unique
  name            String
  type            String
  status          String    @default("active")
  address         Json
  timezone        String    @default("America/Chicago")
  capacity        Json      @default("{}")
  operatingHours  Json?     @map("operating_hours")
  capabilities    String[]
  managerId       String?   @map("manager_id")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  // Lifecycle management
  deleted         Boolean   @default(false)
  deletedAt       DateTime? @map("deleted_at")
  deletedBy       String?   @map("deleted_by")
  deletedReason   String?   @map("deleted_reason")
  retiredAt       DateTime? @map("retired_at")
  retiredBy       String?   @map("retired_by")
  retiredReason   String?   @map("retired_reason")

  manager              User?                 @relation(fields: [managerId], references: [id])
  zones                WarehouseZone[]
  warehouseAllocations WarehouseAllocation[]
  deletedByUser        User?                 @relation("WarehouseDeletedBy", fields: [deletedBy], references: [id])
  retiredByUser        User?                 @relation("WarehouseRetiredBy", fields: [retiredBy], references: [id])

  @@map("warehouses")
  @@schema("company")
  @@index([code])
  @@index([status])
  @@index([managerId])
}

model WarehouseZone {
  id              String   @id @default(dbgenerated("'zone_' || gen_random_uuid()"))
  warehouseId     String   @map("warehouse_id")
  zoneCode        String   @map("zone_code")
  zoneType        String?  @map("zone_type")
  capacityPallets Int?     @map("capacity_pallets")
  notes           String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  warehouse Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@unique([warehouseId, zoneCode])
  @@map("warehouse_zones")
  @@schema("company")
  @@index([warehouseId])
}

// ============================================
// CUSTOMER SCHEMA - THEIR data (multi-tenant)
// ============================================

model Customer {
  id             String   @id @default(dbgenerated("'cust_' || gen_random_uuid()"))
  name           String
  slug           String   @unique
  status         String   @default("prospect")
  setupProgress  Json     @default("{}") @map("setup_progress")
  address        Json?
  internalNotes  String?  @map("internal_notes")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  // Lifecycle management
  deleted        Boolean   @default(false)
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by")
  deletedReason  String?   @map("deleted_reason")
  retiredAt      DateTime? @map("retired_at")
  retiredBy      String?   @map("retired_by")
  retiredReason  String?   @map("retired_reason")
  isTestData     Boolean   @default(false) @map("is_test_data")

  warehouseAllocations WarehouseAllocation[]
  facilities           CustomerFacility[]
  contacts             Contact[]
  contracts            Contract[]
  settings             CustomerSettings?
  contactLog           ContactLog[]
  // Billing relations
  rateCards            RateCard[]
  billingActivities    BillingActivity[]
  invoices             Invoice[]
  
  deletedByUser  User? @relation("CustomerDeletedBy", fields: [deletedBy], references: [id])
  retiredByUser  User? @relation("CustomerRetiredBy", fields: [retiredBy], references: [id])

  @@map("customers")
  @@schema("customer")
  @@index([status])
  @@index([deleted])
}

model WarehouseAllocation {
  id                  String   @id @default(dbgenerated("'alloc_' || gen_random_uuid()"))
  customerId          String   @map("customer_id")
  companyWarehouseId  String   @map("company_warehouse_id")
  isPrimary           Boolean  @default(false) @map("is_primary")
  spaceAllocated      Json?    @map("space_allocated")
  zoneAssignment      String?  @map("zone_assignment")
  status              String   @default("active")
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Lifecycle management
  deleted        Boolean   @default(false)
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by")
  deletedReason  String?   @map("deleted_reason")

  customer  Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [companyWarehouseId], references: [id], onDelete: Restrict)

  @@unique([customerId, companyWarehouseId])
  @@map("warehouse_allocations")
  @@schema("customer")
  @@index([customerId])
  @@index([companyWarehouseId])
  @@index([status])
}

model CustomerFacility {
  id             String   @id @default(dbgenerated("'fac_' || gen_random_uuid()"))
  customerId     String   @map("customer_id")
  name           String
  facilityType   String?  @map("facility_type")
  address        Json
  isSource       Boolean  @default(false) @map("is_source")
  isDestination  Boolean  @default(false) @map("is_destination")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  // Lifecycle management
  deleted        Boolean   @default(false)
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by")
  deletedReason  String?   @map("deleted_reason")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("facilities")
  @@schema("customer")
  @@index([customerId])
  @@index([isSource])
  @@index([isDestination])
}

model Contact {
  id             String   @id @default(dbgenerated("'contact_' || gen_random_uuid()"))
  customerId     String   @map("customer_id")
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  title          String?
  email          String?
  phone          String?
  role           String?
  isPrimary      Boolean  @default(false) @map("is_primary")
  active         Boolean  @default(true)
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  // Lifecycle management
  deleted        Boolean   @default(false)
  deletedAt      DateTime? @map("deleted_at")
  deletedBy      String?   @map("deleted_by")
  deletedReason  String?   @map("deleted_reason")

  customer      Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contactLog    ContactLog[]
  deletedByUser User?        @relation("ContactDeletedBy", fields: [deletedBy], references: [id])

  @@map("contacts")
  @@schema("customer")
  @@index([customerId])
  @@index([isPrimary])
  @@index([active])
}

model ContactLog {
  id            String   @id @default(dbgenerated("'log_' || gen_random_uuid()"))
  customerId    String   @map("customer_id")
  contactId     String?  @map("contact_id")
  loggedByUserId String  @map("logged_by_user_id")
  contactType   String   @map("contact_type")
  subject       String?
  notes         String?
  occurredAt    DateTime @map("occurred_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  contact  Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  user     User     @relation("LoggedByUser", fields: [loggedByUserId], references: [id])

  @@map("contact_log")
  @@schema("customer")
  @@index([customerId])
  @@index([contactId])
  @@index([occurredAt])
  @@index([contactType])
}

model Contract {
  id                      String    @id @default(dbgenerated("'contract_' || gen_random_uuid()"))
  customerId              String    @map("customer_id")
  contractNumber          String?   @unique @map("contract_number")
  name                    String
  startDate               DateTime  @map("start_date") @db.Date
  endDate                 DateTime? @map("end_date") @db.Date
  autoRenew               Boolean   @default(false) @map("auto_renew")
  status                  String    @default("draft")
  billingCycle            String?   @map("billing_cycle")
  paymentTerms            String?   @map("payment_terms")
  notes                   String?
  // Billing system enhancements
  contractType            String?   @map("contract_type")
  parentContractId        String?   @map("parent_contract_id")
  supersededByContractId  String?   @map("superseded_by_contract_id")
  executionDate           DateTime? @map("execution_date") @db.Date
  amendmentNumber         Int?      @map("amendment_number")
  documentUrl             String?   @map("document_url")
  terms                   Json?
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")
  
  // Lifecycle management
  archivedAt     DateTime? @map("archived_at")
  archivedBy     String?   @map("archived_by")
  archivedReason String?   @map("archived_reason")

  customer              Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  rateCardLinks         RateCardContract[]
  archivedByUser        User?              @relation("ContractArchivedBy", fields: [archivedBy], references: [id])
  // Self-referential relations for amendments
  parentContract        Contract?          @relation("ContractAmendments", fields: [parentContractId], references: [id])
  childContracts        Contract[]         @relation("ContractAmendments")
  supersededBy          Contract?          @relation("ContractSupersession", fields: [supersededByContractId], references: [id])
  supersedes            Contract[]         @relation("ContractSupersession")

  @@map("contracts")
  @@schema("customer")
  @@index([customerId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([contractType])
  @@index([parentContractId])
}

model RateCard {
  id                   String    @id @default(dbgenerated("'rate_' || gen_random_uuid()"))
  name                 String
  effectiveDate        DateTime  @map("effective_date")
  version              Int       @default(1)
  supersedesId         String?   @map("supersedes_id")
  // Adjustment support
  rateCardType         String    @default("standard") @map("rate_card_type")
  parentRateCardId     String?   @map("parent_rate_card_id")
  rates                Json      @default("{}")
  isActive             Boolean   @default(true) @map("is_active")
  notes                String?
  // Billing system enhancements
  customerId           String?   @map("customer_id")
  expiresDate          DateTime? @map("expires_date")
  billingCycles        Json      @default("{}") @map("billing_cycles")
  minimumMonthlyCharge Decimal?  @map("minimum_monthly_charge") @db.Decimal(10, 2)
  basedOnTemplate      String?   @map("based_on_template")
  createdBy            String?   @map("created_by")
  // Soft delete fields (following app's deletion philosophy)
  archivedAt           DateTime? @map("archived_at")
  archivedBy           String?   @map("archived_by")
  archivedReason       String?   @map("archived_reason")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  customer          Customer?          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdByUser     User?              @relation("RateCardCreatedBy", fields: [createdBy], references: [id])
  archivedByUser    User?              @relation("RateCardArchivedBy", fields: [archivedBy], references: [id])
  // Parent-child version relations (for versioning)
  parentRateCard    RateCard?          @relation("RateCardVersions", fields: [supersedesId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childVersions     RateCard[]         @relation("RateCardVersions")
  // Parent-child adjustment relations  
  parentForAdjustment RateCard?        @relation("RateCardAdjustments", fields: [parentRateCardId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  adjustmentChildren  RateCard[]       @relation("RateCardAdjustments")
  // Other relations
  contractLinks     RateCardContract[]
  billingActivities BillingActivity[]

  @@map("rate_cards")
  @@schema("customer")
  @@index([customerId])
  @@index([isActive])
  @@index([effectiveDate])
  @@index([expiresDate])
  @@index([archivedAt])
  @@index([parentRateCardId])
  @@index([rateCardType])
  @@index([supersedesId])
  @@index([customerId, isActive])
}

model CustomerSettings {
  customerId              String   @id @map("customer_id")
  portalEnabled           Boolean  @default(false) @map("portal_enabled")
  portalSubdomain         String?  @unique @map("portal_subdomain")
  notificationEmail       String?  @map("notification_email")
  notificationPreferences Json     @default("{}") @map("notification_preferences")
  timezone                String   @default("America/Chicago")
  settings                Json     @default("{}")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("settings")
  @@schema("customer")
  @@index([portalEnabled])
}

// ============================================
// BILLING MODELS
// ============================================

model RateCardContract {
  rateCardId String   @map("rate_card_id")
  contractId String   @map("contract_id")
  linkType   String?  @map("link_type")
  linkedAt   DateTime @default(now()) @map("linked_at")
  linkedBy   String?  @map("linked_by")
  notes      String?

  rateCard     RateCard @relation(fields: [rateCardId], references: [id], onDelete: Cascade)
  contract     Contract @relation(fields: [contractId], references: [id], onDelete: Restrict)
  linkedByUser User?    @relation("RateCardContractLinkedBy", fields: [linkedBy], references: [id])

  @@id([rateCardId, contractId])
  @@map("rate_card_contracts")
  @@schema("customer")
  @@index([rateCardId])
  @@index([contractId])
}

model BillingActivity {
  id                 String    @id @default(dbgenerated("'act_' || gen_random_uuid()"))
  customerId         String    @map("customer_id")
  activityDate       DateTime  @map("activity_date")
  type               String
  quantity           Decimal   @db.Decimal(10, 3)
  unit               String?
  description        String?
  referenceId        String?   @map("reference_id")
  importBatchId      String?   @map("import_batch_id")
  rateApplied        Decimal?  @map("rate_applied") @db.Decimal(10, 2)
  rateCardId         String?   @map("rate_card_id")
  amount             Decimal?  @db.Decimal(12, 2)
  billingCycle       String    @map("billing_cycle")
  billingPeriodStart DateTime? @map("billing_period_start") @db.Date
  isManualOverride   Boolean   @default(false) @map("is_manual_override")
  overrideReason     String?   @map("override_reason")
  source             String?
  metadata           Json?
  invoiced           Boolean   @default(false)
  invoiceId          String?   @map("invoice_id")
  importedAt         DateTime  @default(now()) @map("imported_at")
  importedBy         String?   @map("imported_by")

  customer        Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  rateCard        RateCard?     @relation(fields: [rateCardId], references: [id])
  invoice         Invoice?      @relation(fields: [invoiceId], references: [id])
  importedByUser  User?         @relation("BillingActivityImportedBy", fields: [importedBy], references: [id])
  invoiceLines    InvoiceLine[]

  @@unique([customerId, referenceId, activityDate, type])
  @@map("billing_activities")
  @@schema("customer")
  @@index([customerId])
  @@index([activityDate])
  @@index([type])
  @@index([referenceId])
  @@index([customerId, billingCycle, billingPeriodStart])
  @@index([customerId, invoiced])
  @@index([importBatchId])
  @@index([rateCardId])
  @@index([invoiceId])
}

model Invoice {
  id                String    @id @default(dbgenerated("'inv_' || gen_random_uuid()"))
  customerId        String    @map("customer_id")
  invoiceNumber     String    @unique @map("invoice_number")
  billingCycle      String    @map("billing_cycle")
  periodStart       DateTime  @map("period_start") @db.Date
  periodEnd         DateTime  @map("period_end") @db.Date
  issuedAt          DateTime? @map("issued_at")
  dueDate           DateTime? @map("due_date")
  status            String    @default("draft")
  subtotal          Decimal   @db.Decimal(12, 2)
  tax               Decimal   @default(0) @db.Decimal(12, 2)
  total             Decimal   @db.Decimal(12, 2)
  balanceDue        Decimal   @map("balance_due") @db.Decimal(12, 2)
  dataSnapshot      Json?     @map("data_snapshot")
  pdfUrl            String?   @map("pdf_url")
  notes             String?
  internalNotes     String?   @map("internal_notes")
  createdAt         DateTime  @default(now()) @map("created_at")
  createdBy         String?   @map("created_by")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  customer           Customer          @relation(fields: [customerId], references: [id], onDelete: Restrict)
  createdByUser      User?             @relation("InvoiceCreatedBy", fields: [createdBy], references: [id])
  lines              InvoiceLine[]
  payments           Payment[]
  billingActivities  BillingActivity[]

  @@map("invoices")
  @@schema("customer")
  @@index([customerId])
  @@index([invoiceNumber])
  @@index([customerId, periodStart, periodEnd])
  @@index([status])
  @@index([billingCycle])
  @@index([dueDate, status])
}

model InvoiceLine {
  id          String   @id @default(dbgenerated("'line_' || gen_random_uuid()"))
  invoiceId   String   @map("invoice_id")
  activityId  String?  @map("activity_id")
  description String
  category    String?
  quantity    Decimal  @db.Decimal(10, 3)
  unit        String?
  unitRate    Decimal  @map("unit_rate") @db.Decimal(10, 2)
  lineTotal   Decimal  @map("line_total") @db.Decimal(12, 2)
  lineOrder   Int?     @map("line_order")

  invoice  Invoice          @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  activity BillingActivity? @relation(fields: [activityId], references: [id])

  @@map("invoice_lines")
  @@schema("customer")
  @@index([invoiceId])
  @@index([activityId])
  @@index([category])
}

model Payment {
  id           String   @id @default(dbgenerated("'pay_' || gen_random_uuid()"))
  invoiceId    String   @map("invoice_id")
  amount       Decimal  @db.Decimal(12, 2)
  paymentDate  DateTime @map("payment_date") @db.Date
  method       String
  reference    String?
  status       String   @default("applied")
  notes        String?
  recordedAt   DateTime @default(now()) @map("recorded_at")
  recordedBy   String?  @map("recorded_by")

  invoice         Invoice @relation(fields: [invoiceId], references: [id], onDelete: Restrict)
  recordedByUser  User?   @relation("PaymentRecordedBy", fields: [recordedBy], references: [id])

  @@map("payments")
  @@schema("customer")
  @@index([invoiceId])
  @@index([paymentDate])
  @@index([status])
  @@index([method])
}